module sub_rk
!! Fortran module for main_rk.f90 which solves the dynamic response of 
!! a metabeam of bistable elements using an explicit Runge-Kutta method.
!!
!! Author: Written by Myungwon Hwang (hwang125@purdue.edu)

implicit none
private
public :: calc_f_metabeam, calc_f_pendula, calc_f_phi4, calc_load
public :: DoF, noState, s_dim

integer :: DoF ! unit cell degrees of freedom
integer :: noState ! number of states per unit cell
integer :: s_dim


contains
    subroutine calc_f_metabeam(BC_flag, lowerBound, upperBound, m, b, p, s, x, f)

    !! Data dictionary
    integer, intent(in) :: BC_flag
    integer, intent(in) :: lowerBound
    integer, intent(in) :: upperBound
    real, intent(in), dimension(DoF) :: m
    real, intent(in), dimension(DoF) :: b
    real, intent(in), dimension(DoF) :: p
    real, intent(in), dimension(s_dim) :: s
    real, intent(in), dimension(lowerBound:upperBound) :: x
    real, intent(out), dimension(noState) :: f

    f = 0.
    if (BC_flag == 100) then
        f(1) = x(1)

        f(2) = ( p(1) -b(1)*x(1) - ((s(1)*(s(9) - x(-12) + x(0))*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)))/&
        &   Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
        &  (s(2)*(s(12) - x(0) + x(4))*(Sqrt(s(10)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(3)*(s(12) - x(0) + x(8))*(Sqrt(s(11)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2)))/&
        &   Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) - &
        &  (s(1)*(s(9) - x(0) + x(12))*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)))/&
        &   Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(1)

        f(3) = x(3)
       
        f(4) = ( p(2) -b(2)*x(3) - ((s(1)*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2))*(-x(-10) + x(2)))/&
        &   Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
        &  (s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(3)*(-Sqrt(s(11)**2 + s(12)**2) + Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2))*&
        &     (s(11) + x(2) - x(10)))/Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) + &
        &  (s(1)*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2))*(x(2) - x(14)))/&
        &   Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(2)

        f(5) = x(5)

        f(6) = ( p(3) -b(3)*x(5) - ((s(4)*(s(9) - x(-8) + x(4))*(-s(9) + Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2)))/&
        &   Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) + &
        &  (s(7)*(s(9) - x(-4) + x(4))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2)))/&
        &   Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2) + &
        &  (s(2)*(s(12) - x(0) + x(4))*(-Sqrt(s(10)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(6)*(x(4) - x(8))*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)))/&
        &   Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) - &
        &  (s(4)*(s(9) - x(4) + x(16))*(-s(9) + Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2)))/&
        &   Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2) - &
        &  (s(8)*(s(9) - x(4) + x(20))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)))/&
        &   Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)) )/m(3)

        f(7) = x(7)
        
        f(8) = ( p(4) -b(4)*x(7) - ((s(4)*(-s(9) + Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2))*(-x(-6) + x(6)))/&
        &   Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) + &
        &  (s(7)*(s(10) + s(11) - x(-2) + x(6))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2)))/&
        &   Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2) + &
        &  (s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(6)*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2))*&
        &     (s(10) + s(11) + x(6) - x(10)))/Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) + &
        &  (s(4)*(-s(9) + Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2))*(x(6) - x(18)))/&
        &   Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2) + &
        &  (s(8)*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2))*(s(10) + s(11) + x(6) - x(22)))/&
        &   Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)) )/m(4)

        f(9) = x(9)

        f(10) = ( p(5) -b(5)*x(9) - ((s(8)*(s(9) - x(-8) + x(8))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(-8) + x(8))**2 + (s(10) + s(11) + x(-6) - x(10))**2)))/&
        &   Sqrt((s(9) - x(-8) + x(8))**2 + (s(10) + s(11) + x(-6) - x(10))**2) + &
        &  (s(5)*(s(9) - x(-4) + x(8))*(-s(9) + Sqrt((s(9) - x(-4) + x(8))**2 + (x(-2) - x(10))**2)))/&
        &   Sqrt((s(9) - x(-4) + x(8))**2 + (x(-2) - x(10))**2) + &
        &  (s(3)*(s(12) - x(0) + x(8))*(-Sqrt(s(11)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2)))/&
        &   Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) - &
        &  (s(6)*(x(4) - x(8))*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)))/&
        &   Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) - &
        &  (s(7)*(s(9) - x(8) + x(16))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(8) + x(16))**2 + (s(10) + s(11) - x(10) + x(18))**2)))/&
        &   Sqrt((s(9) - x(8) + x(16))**2 + (s(10) + s(11) - x(10) + x(18))**2) - &
        &  (s(5)*(s(9) - x(8) + x(20))*(-s(9) + Sqrt((s(9) - x(8) + x(20))**2 + (x(10) - x(22))**2)))/&
        &   Sqrt((s(9) - x(8) + x(20))**2 + (x(10) - x(22))**2)) )/m(5)

        f(11) = x(11)

        f(12) = ( p(6) -b(6)*x(11) - (-((s(8)*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &         Sqrt((s(9) - x(-8) + x(8))**2 + (s(10) + s(11) + x(-6) - x(10))**2))*(s(10) + s(11) + x(-6) - x(10)))/&
        &     Sqrt((s(9) - x(-8) + x(8))**2 + (s(10) + s(11) + x(-6) - x(10))**2)) + &
        &  (s(3)*(Sqrt(s(11)**2 + s(12)**2) - Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2))*&
        &     (s(11) + x(2) - x(10)))/Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) - &
        &  (s(6)*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2))*&
        &     (s(10) + s(11) + x(6) - x(10)))/Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) + &
        &  (s(5)*(-s(9) + Sqrt((s(9) - x(-4) + x(8))**2 + (x(-2) - x(10))**2))*(-x(-2) + x(10)))/&
        &   Sqrt((s(9) - x(-4) + x(8))**2 + (x(-2) - x(10))**2) - &
        &  (s(7)*(s(10) + s(11) - x(10) + x(18))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(8) + x(16))**2 + (s(10) + s(11) - x(10) + x(18))**2)))/&
        &   Sqrt((s(9) - x(8) + x(16))**2 + (s(10) + s(11) - x(10) + x(18))**2) + &
        &  (s(5)*(-s(9) + Sqrt((s(9) - x(8) + x(20))**2 + (x(10) - x(22))**2))*(x(10) - x(22)))/&
        &   Sqrt((s(9) - x(8) + x(20))**2 + (x(10) - x(22))**2)) )/m(6)

    else if (BC_flag == 110) then
        f(1) = x(1)

        f(2) = ( p(1) - b(1)*x(1) - ((s(2)*(s(12) - x(0) + x(4))*(Sqrt(s(10)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(3)*(s(12) - x(0) + x(8))*(Sqrt(s(11)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2)))/&
        &   Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) - &
        &  (s(1)*(s(9) - x(0) + x(12))*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)))/&
        &   Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) - ((s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(3)*(-Sqrt(s(11)**2 + s(12)**2) + Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2))*&
        &     (s(11) + x(2) - x(10)))/Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) + &
        &  (s(1)*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2))*(x(2) - x(14)))/&
        &   Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(2)

        f(5) = x(5)

        f(6) = ( p(3) - b(3)*x(5) - ((s(2)*(s(12) - x(0) + x(4))*(-Sqrt(s(10)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(6)*(x(4) - x(8))*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)))/&
        &   Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) - &
        &  (s(4)*(s(9) - x(4) + x(16))*(-s(9) + Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2)))/&
        &   Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2) - &
        &  (s(8)*(s(9) - x(4) + x(20))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)))/&
        &   Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)) )/m(3)

        f(7) = x(7)

        f(8) = ( p(4) - b(4)*x(7) - ((s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(6)*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2))*&
        &     (s(10) + s(11) + x(6) - x(10)))/Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) + &
        &  (s(4)*(-s(9) + Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2))*(x(6) - x(18)))/&
        &   Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2) + &
        &  (s(8)*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2))*(s(10) + s(11) + x(6) - x(22)))/&
        &   Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)) )/m(4)

        f(9) = x(9)

        f(10) = ( p(5) - b(5)*x(9) - ((s(3)*(s(12) - x(0) + x(8))*(-Sqrt(s(11)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2)))/&
        &   Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) - &
        &  (s(6)*(x(4) - x(8))*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)))/&
        &   Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) - &
        &  (s(7)*(s(9) - x(8) + x(16))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(8) + x(16))**2 + (s(10) + s(11) - x(10) + x(18))**2)))/&
        &   Sqrt((s(9) - x(8) + x(16))**2 + (s(10) + s(11) - x(10) + x(18))**2) - &
        &  (s(5)*(s(9) - x(8) + x(20))*(-s(9) + Sqrt((s(9) - x(8) + x(20))**2 + (x(10) - x(22))**2)))/&
        &   Sqrt((s(9) - x(8) + x(20))**2 + (x(10) - x(22))**2)) )/m(5)

        f(11) = x(11)

        f(12) = ( p(6) - b(6)*x(11) - ((s(3)*(Sqrt(s(11)**2 + s(12)**2) &
        &  - Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2))*&
        &     (s(11) + x(2) - x(10)))/Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) - &
        &  (s(6)*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2))*&
        &     (s(10) + s(11) + x(6) - x(10)))/Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) - &
        &  (s(7)*(s(10) + s(11) - x(10) + x(18))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(8) + x(16))**2 + (s(10) + s(11) - x(10) + x(18))**2)))/&
        &   Sqrt((s(9) - x(8) + x(16))**2 + (s(10) + s(11) - x(10) + x(18))**2) + &
        &  (s(5)*(-s(9) + Sqrt((s(9) - x(8) + x(20))**2 + (x(10) - x(22))**2))*(x(10) - x(22)))/&
        &   Sqrt((s(9) - x(8) + x(20))**2 + (x(10) - x(22))**2)) )/m(6)

    else if (BC_flag == 111) then
        f(1) = x(1)
        
        f(2) = ( p(1) - b(1)*x(1) - ((s(2)*(s(12) - x(0))*(Sqrt(s(10)**2 + s(12)**2) &
        &  - Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2) + &
        &  (s(3)*(s(12) - x(0))*(Sqrt(s(11)**2 + s(12)**2) - Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) - &
        &  (s(1)*(s(9) - x(0) + x(12))*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)))/&
        &   Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) - ((s(2)*(Sqrt(s(10)**2 + s(12)**2) &
        &  - Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2))*(s(10) - x(2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2) + &
        &  (s(3)*(s(11) + x(2))*(-Sqrt(s(11)**2 + s(12)**2) + Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
        &  (s(1)*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2))*(x(2) - x(14)))/&
        &   Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(2)

    else if (BC_flag == 112) then
        f(1) = x(1)
        
        f(2) = ( p(1) - b(1)*x(1) - ((s(2)*(s(12) - x(0))*(Sqrt(s(10)**2 + s(12)**2) &
        &  - Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2) + &
        &  (s(3)*(s(12) - x(0))*(Sqrt(s(11)**2 + s(12)**2) - Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) - &
        &  (s(1)*(s(9) - x(0) + x(12))*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)))/&
        &   Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(1)

    else if (BC_flag == 113) then
        f(1) = x(1)

        f(2) = ( p(1) - b(1)*x(1) - ((s(3)*(s(12) - x(0))*(Sqrt(s(11)**2 + s(12)**2) - &
            &      Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &  Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            & (s(2)*(s(12) - x(0) + x(4))*(Sqrt(s(10)**2 + s(12)**2) - &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) - &
            & (s(1)*(s(9) - x(0) + x(12))*(-s(9) + &
            &      Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)))/&
            &  Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) - ((s(3)*(s(11) + x(2))*(-Sqrt(s(11)**2 + s(12)**2) + &
            &      Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &  Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            & (s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
            & (s(1)*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2))*(x(2) - x(14)))/&
            &  Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(2)

        f(5) = x(5)

        f(6) = ( p(3) -b(3)*x(5) - ((s(6)*x(4)*(-s(10) - s(11) + Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2)))/&
            &  Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2) + &
            & (s(2)*(s(12) - x(0) + x(4))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) - &
            & (s(4)*(s(9) - x(4) + x(16))*(-s(9) + &
            &      Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2)))/&
            &  Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2) - &
            & (s(8)*(s(9) - x(4) + x(20))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &      Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)))/&
            &  Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)) )/m(3)

        f(7) = x(7)
        
        f(8) = ( p(4) -b(4)*x(7) - ((s(6)*(s(10) + s(11) + x(6))*(-s(10) - s(11) + &
            &      Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2)))/&
            &  Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2) + &
            & (s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
            & (s(4)*(-s(9) + Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2))*(x(6) - x(18)))/&
            &  Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2) + &
            & (s(8)*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &      Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2))*&
            &    (s(10) + s(11) + x(6) - x(22)))/&
            &  Sqrt((s(9) - x(4) + x(20))**2 + (s(10) + s(11) + x(6) - x(22))**2)) )/m(4)

    else if (BC_flag == 120) then
        f(1) = x(1)

        f(2) = ( p(1) - b(1)*x(1) - ((s(1)*(s(9) - x(-12) + x(0))*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)))/&
        &   Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
        &  (s(2)*(s(12) - x(0) + x(4))*(Sqrt(s(10)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(3)*(s(12) - x(0) + x(8))*(Sqrt(s(11)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2)))/&
        &   Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) - ((s(1)*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2))*(-x(-10) + x(2)))/&
        &   Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
        &  (s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(3)*(-Sqrt(s(11)**2 + s(12)**2) + Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2))*&
        &     (s(11) + x(2) - x(10)))/Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2)) )/m(2)

        f(5) = x(5)

        f(6) = ( p(3) - b(3)*x(5) - ((s(4)*(s(9) - x(-8) + x(4))*(-s(9) + Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2)))/&
        &   Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) + &
        &  (s(7)*(s(9) - x(-4) + x(4))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2)))/&
        &   Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2) + &
        &  (s(2)*(s(12) - x(0) + x(4))*(-Sqrt(s(10)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(6)*(x(4) - x(8))*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)))/&
        &   Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)) )/m(3)

        f(7) = x(7)

        f(8) = ( p(4) - b(4)*x(7) - ((s(4)*(-s(9) + Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2))*(-x(-6) + x(6)))/&
        &   Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) + &
        &  (s(7)*(s(10) + s(11) - x(-2) + x(6))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2)))/&
        &   Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2) + &
        &  (s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
        &   Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
        &  (s(6)*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2))*&
        &     (s(10) + s(11) + x(6) - x(10)))/Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)) )/m(4)

        f(9) = x(9)

        f(10) = ( p(5) - b(5)*x(9) - ((s(8)*(s(9) - x(-8) + x(8))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &       Sqrt((s(9) - x(-8) + x(8))**2 + (s(10) + s(11) + x(-6) - x(10))**2)))/&
        &   Sqrt((s(9) - x(-8) + x(8))**2 + (s(10) + s(11) + x(-6) - x(10))**2) + &
        &  (s(5)*(s(9) - x(-4) + x(8))*(-s(9) + Sqrt((s(9) - x(-4) + x(8))**2 + (x(-2) - x(10))**2)))/&
        &   Sqrt((s(9) - x(-4) + x(8))**2 + (x(-2) - x(10))**2) + &
        &  (s(3)*(s(12) - x(0) + x(8))*(-Sqrt(s(11)**2 + s(12)**2) + &
        &       Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2)))/&
        &   Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) - &
        &  (s(6)*(x(4) - x(8))*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)))/&
        &   Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2)) )/m(5)

        f(11) = x(11)

        f(12) = ( p(6) - b(6)*x(11) - (-((s(8)*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
        &         Sqrt((s(9) - x(-8) + x(8))**2 + (s(10) + s(11) + x(-6) - x(10))**2))*(s(10) + s(11) + x(-6) - x(10)))/&
        &     Sqrt((s(9) - x(-8) + x(8))**2 + (s(10) + s(11) + x(-6) - x(10))**2)) + &
        &  (s(3)*(Sqrt(s(11)**2 + s(12)**2) - Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2))*&
        &     (s(11) + x(2) - x(10)))/Sqrt((s(12) - x(0) + x(8))**2 + (s(11) + x(2) - x(10))**2) - &
        &  (s(6)*(-s(10) - s(11) + Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2))*&
        &     (s(10) + s(11) + x(6) - x(10)))/Sqrt((x(4) - x(8))**2 + (s(10) + s(11) + x(6) - x(10))**2) + &
        &  (s(5)*(-s(9) + Sqrt((s(9) - x(-4) + x(8))**2 + (x(-2) - x(10))**2))*(-x(-2) + x(10)))/&
        &   Sqrt((s(9) - x(-4) + x(8))**2 + (x(-2) - x(10))**2)) )/m(6)

    else if (BC_flag == 121) then
        f(1) = x(1)
        
        f(2) = ( p(1) - b(1)*x(1) - ((s(2)*(s(12) - x(0))*(Sqrt(s(10)**2 + s(12)**2) &
        &  - Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2) + &
        &  (s(1)*(s(9) - x(-12) + x(0))*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)))/&
        &   Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
        &  (s(3)*(s(12) - x(0))*(Sqrt(s(11)**2 + s(12)**2) - Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) - ((s(2)*(Sqrt(s(10)**2 + s(12)**2) &
        &  - Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2))*(s(10) - x(2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2) + &
        &  (s(1)*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2))*(-x(-10) + x(2)))/&
        &   Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
        &  (s(3)*(s(11) + x(2))*(-Sqrt(s(11)**2 + s(12)**2) + Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
        &   Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)) )/m(2)

    else if (BC_flag == 123) then
        f(1) = x(1)

        f(2) = ( p(1) - b(1)*x(1) - ((s(1)*(s(9) - x(-12) + x(0))*(-s(9) + &
            &      Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)))/&
            &  Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
            & (s(3)*(s(12) - x(0))*(Sqrt(s(11)**2 + s(12)**2) - &
            &      Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &  Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            & (s(2)*(s(12) - x(0) + x(4))*(Sqrt(s(10)**2 + s(12)**2) - &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) - ((s(1)*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2))*&
            &    (-x(-10) + x(2)))/Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
            & (s(3)*(s(11) + x(2))*(-Sqrt(s(11)**2 + s(12)**2) + &
            &      Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &  Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            & (s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)) )/m(2)

        f(5) = x(5)

        f(6) = ( p(3) -b(3)*x(5) - ((s(4)*(s(9) - x(-8) + x(4))*(-s(9) + &
            &      Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2)))/&
            &  Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) + &
            & (s(6)*x(4)*(-s(10) - s(11) + Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2)))/&
            &  Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2) + &
            & (s(7)*(s(9) - x(-4) + x(4))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &      Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2)))/&
            &  Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2) + &
            & (s(2)*(s(12) - x(0) + x(4))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)) )/m(3)

        f(7) = x(7)
        
        f(8) = ( p(4) -b(4)*x(7) - ((s(4)*(-s(9) + Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2))*(-x(-6) + x(6)))/&
            &  Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) + &
            & (s(6)*(s(10) + s(11) + x(6))*(-s(10) - s(11) + &
            &      Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2)))/&
            &  Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2) + &
            & (s(7)*(s(10) + s(11) - x(-2) + x(6))*&
            &    (-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &      Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2)))/&
            &  Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2) + &
            & (s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)) )/m(4)

    else if (BC_flag == 124) then
        f(1) = x(1)

        f(2) = ( p(1) -b(1)*x(1) - ((s(1)*(s(9) - x(-12) + x(0))*(-s(9) + &
            &      Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)))/&
            &  Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
            & (s(2)*(s(12) - x(0) + x(4))*(Sqrt(s(10)**2 + s(12)**2) - &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
            & (s(3)*(s(12) - x(0) + x(8))*(Sqrt(s(11)**2 + s(12)**2) - &
            &      Sqrt((s(11) + x(2))**2 + (s(12) - x(0) + x(8))**2)))/&
            &  Sqrt((s(11) + x(2))**2 + (s(12) - x(0) + x(8))**2)) )/m(1)

        f(3) = x(3)
       
        f(4) = ( p(2) -b(2)*x(3) - ((s(1)*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2))*&
            &    (-x(-10) + x(2)))/Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
            & (s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
            & (s(3)*(s(11) + x(2))*(-Sqrt(s(11)**2 + s(12)**2) + &
            &      Sqrt((s(11) + x(2))**2 + (s(12) - x(0) + x(8))**2)))/&
            &  Sqrt((s(11) + x(2))**2 + (s(12) - x(0) + x(8))**2)) )/m(2)

        f(5) = x(5)

        f(6) = ( p(3) -b(3)*x(5) - ((s(4)*(s(9) - x(-8) + x(4))*(-s(9) + &
            &      Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2)))/&
            &  Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) + &
            & (s(7)*(s(9) - x(-4) + x(4))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &      Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2)))/&
            &  Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2) + &
            & (s(2)*(s(12) - x(0) + x(4))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
            & (s(6)*(-s(10) - s(11) + Sqrt((s(10) + s(11) + x(6))**2 + (x(4) - x(8))**2))*&
            &    (x(4) - x(8)))/Sqrt((s(10) + s(11) + x(6))**2 + (x(4) - x(8))**2)) )/m(3)

        f(7) = x(7)
        
        f(8) = ( p(4) -b(4)*x(7) - ((s(4)*(-s(9) + Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2))*(-x(-6) + x(6)))/&
            &  Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) + &
            & (s(7)*(s(10) + s(11) - x(-2) + x(6))*&
            &    (-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &      Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2)))/&
            &  Sqrt((s(9) - x(-4) + x(4))**2 + (s(10) + s(11) - x(-2) + x(6))**2) + &
            & (s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &      Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &  Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
            & (s(6)*(s(10) + s(11) + x(6))*(-s(10) - s(11) + &
            &      Sqrt((s(10) + s(11) + x(6))**2 + (x(4) - x(8))**2)))/&
            &  Sqrt((s(10) + s(11) + x(6))**2 + (x(4) - x(8))**2)) )/m(4)

        f(9) = x(9)

        f(10) = ( p(5) -b(5)*x(9) - (-((s(6)*(-s(10) - s(11) + Sqrt((s(10) + s(11) + x(6))**2 + (x(4) - x(8))**2))*&
            &      (x(4) - x(8)))/Sqrt((s(10) + s(11) + x(6))**2 + (x(4) - x(8))**2)) + &
            & (s(8)*(s(9) - x(-8) + x(8))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &      Sqrt((s(10) + s(11) + x(-6))**2 + (s(9) - x(-8) + x(8))**2)))/&
            &  Sqrt((s(10) + s(11) + x(-6))**2 + (s(9) - x(-8) + x(8))**2) + &
            & (s(5)*(s(9) - x(-4) + x(8))*(-s(9) + Sqrt(x(-2)**2 + (s(9) - x(-4) + x(8))**2)))/&
            &  Sqrt(x(-2)**2 + (s(9) - x(-4) + x(8))**2) + &
            & (s(3)*(s(12) - x(0) + x(8))*(-Sqrt(s(11)**2 + s(12)**2) + &
            &      Sqrt((s(11) + x(2))**2 + (s(12) - x(0) + x(8))**2)))/&
            &  Sqrt((s(11) + x(2))**2 + (s(12) - x(0) + x(8))**2)) )/m(5)

    else if (BC_flag == 200) then
        f(1) = x(1)

        f(2) = ( p(1) - b(1)*x(1) - ((s(1)*(s(9) - x(-12) + x(0))*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)))/&
            &Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
            &(s(3)*(s(12) - x(0))*(Sqrt(s(11)**2 + s(12)**2) - Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            &(s(2)*(s(12) - x(0) + x(4))*(Sqrt(s(10)**2 + s(12)**2) - &
            &Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) - &
            &(s(1)*(s(9) - x(0) + x(12))*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)))/&
            &Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) -(-((s(1)*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2))*(x(-10) - x(2)))/&
            &Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)) + &
            &(s(3)*(s(11) + x(2))*(-Sqrt(s(11)**2 + s(12)**2) + Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            &(s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
            &Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
            &(s(1)*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2))*(x(2) - x(14)))/&
            &Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(2)

        f(5) = x(5)

        f(6) = ( p(3) - b(3)*x(5) - ((s(4)*(s(9) - x(-8) + x(4))*(-s(9) + Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2)))/&
            &Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2) - &
            &(s(8)*(s(9) - x(4))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &Sqrt((s(9) - x(4))**2 + (s(10) + s(11) + x(6))**2)))/&
            &Sqrt((s(9) - x(4))**2 + (s(10) + s(11) + x(6))**2) + &
            &(s(6)*x(4)*(-s(10) - s(11) + Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2)))/&
            &Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2) + &
            &(s(7)*(s(9) + x(4))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &Sqrt((s(9) + x(4))**2 + (s(10) + s(11) + x(6))**2)))/&
            &Sqrt((s(9) + x(4))**2 + (s(10) + s(11) + x(6))**2) + &
            &(s(2)*(s(12) - x(0) + x(4))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) - &
            &(s(4)*(s(9) - x(4) + x(16))*(-s(9) + Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2)))/&
            &Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2)) )/m(3)

        f(7) = x(7)

        f(8) = ( p(4) - b(4)*x(7) - (-((s(4)*(-s(9) + Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2))*(x(-6) - x(6)))/&
            &Sqrt((s(9) - x(-8) + x(4))**2 + (x(-6) - x(6))**2)) + &
            &(s(8)*(s(10) + s(11) + x(6))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &Sqrt((s(9) - x(4))**2 + (s(10) + s(11) + x(6))**2)))/&
            &Sqrt((s(9) - x(4))**2 + (s(10) + s(11) + x(6))**2) + &
            &(s(6)*(s(10) + s(11) + x(6))*(-s(10) - s(11) + Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2)))/&
            &Sqrt(x(4)**2 + (s(10) + s(11) + x(6))**2) + &
            &(s(7)*(s(10) + s(11) + x(6))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &Sqrt((s(9) + x(4))**2 + (s(10) + s(11) + x(6))**2)))/&
            &Sqrt((s(9) + x(4))**2 + (s(10) + s(11) + x(6))**2) + &
            &(s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0) + x(4))**2 + (s(10) - x(2) + x(6))**2) + &
            &(s(4)*(-s(9) + Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2))*(x(6) - x(18)))/&
            &Sqrt((s(9) - x(4) + x(16))**2 + (x(6) - x(18))**2)) )/m(4)


    else if (BC_flag == 2112) then
        f(1) = x(1)

        f(2) = ( p(1) - b(1)*x(1) - ((s(3)*(s(12) - x(0))*(Sqrt(s(11)**2 + s(12)**2) &
            &  - Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            &(s(2)*(s(12) - x(0))*(Sqrt(s(10)**2 + s(12)**2) - &
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2) - &
            &(s(1)*(s(9) - x(0) + x(12))*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)))/&
            &Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) -((s(3)*(s(11) + x(2))*(-Sqrt(s(11)**2 + s(12)**2) &
            &  + Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            &(s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2) + &
            &(s(1)*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2))*(x(2) - x(14)))/&
            &Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(2)

        f(7) = x(7)

        f(8) = ( p(4) - b(4)*x(7) - ((s(6)*(s(10) + s(11) + x(6))*(-s(10) - s(11) + Sqrt((s(10) + s(11) + x(6))**2)))/&
            &Sqrt((s(10) + s(11) + x(6))**2) + &
            &(s(8)*(s(10) + s(11) + x(6))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &Sqrt(s(9)**2 + (s(10) + s(11) + x(6))**2)))/Sqrt(s(9)**2 + (s(10) + s(11) + x(6))**2) + &
            &(s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2) + &
            &(s(4)*(-s(9) + Sqrt((s(9) + x(16))**2 + (x(6) - x(18))**2))*(x(6) - x(18)))/&
            &Sqrt((s(9) + x(16))**2 + (x(6) - x(18))**2)) )/m(4)


    else if (BC_flag == 2212) then
        f(1) = x(1)

        f(2) = ( p(1) - b(1)*x(1) - ((s(1)*(s(9) - x(-12) + x(0))*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)))/&
            &Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
            &(s(3)*(s(12) - x(0))*(Sqrt(s(11)**2 + s(12)**2) - Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            &(s(2)*(s(12) - x(0))*(Sqrt(s(10)**2 + s(12)**2) - &
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2) - b(2)*x(3) -(-((s(1)*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2))*(x(-10) - x(2)))/&
            &Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)) + &
            &(s(3)*(s(11) + x(2))*(-Sqrt(s(11)**2 + s(12)**2) + Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(11) + x(2))**2) + &
            &(s(2)*(s(10) - x(2) + x(6))*(Sqrt(s(10)**2 + s(12)**2) - &
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)) )/m(2)

        f(7) = x(7)

        f(8) = ( p(4) - b(4)*x(7) - (-((s(4)*(-s(9) + Sqrt((s(9) - x(-8))**2 + (x(-6) - x(6))**2))*(x(-6) - x(6)))/&
            &Sqrt((s(9) - x(-8))**2 + (x(-6) - x(6))**2)) + &
            &(s(6)*(s(10) + s(11) + x(6))*(-s(10) - s(11) + Sqrt((s(10) + s(11) + x(6))**2)))/&
            &Sqrt((s(10) + s(11) + x(6))**2) + &
            &(s(7)*(s(10) + s(11) + x(6))*(-Sqrt(s(9)**2 + (s(10) + s(11))**2) + &
            &Sqrt(s(9)**2 + (s(10) + s(11) + x(6))**2)))/Sqrt(s(9)**2 + (s(10) + s(11) + x(6))**2) + &
            &(s(2)*(s(10) - x(2) + x(6))*(-Sqrt(s(10)**2 + s(12)**2) + &
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)))/&
            &Sqrt((s(12) - x(0))**2 + (s(10) - x(2) + x(6))**2)) )/m(4)


    else if (BC_flag == 700 .or. BC_flag == 710 .or. BC_flag == 720) then
        f(1) = x(1)

        f(2) = ( p(1)-b(1)*x(1) - ((s(2)*(s(12) - x(0))*(Sqrt(s(10)**2 + s(12)**2) - Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2)))/&
            & Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2) + &
            & (s(1)*(s(9) - x(-12) + x(0))*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2)))/&
            & Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
            & (s(2)*(s(12) - x(0))*(Sqrt(s(10)**2 + s(12)**2) - Sqrt((s(12) - x(0))**2 + (s(10) + x(2))**2)))/&
            & Sqrt((s(12) - x(0))**2 + (s(10) + x(2))**2) - &
            & (s(1)*(s(9) - x(0) + x(12))*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)))/&
            & Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(1)

        f(3) = x(3)

        f(4) = ( p(2)-b(2)*x(3) - ((s(2)*(Sqrt(s(10)**2 + s(12)**2) - Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2))*(s(10) - x(2)))/&
            & Sqrt((s(12) - x(0))**2 + (s(10) - x(2))**2) - &
            & (s(1)*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2))*(x(-10) - x(2)))/&
            & Sqrt((s(9) - x(-12) + x(0))**2 + (x(-10) - x(2))**2) + &
            & (s(2)*(s(10) + x(2))*(-Sqrt(s(10)**2 + s(12)**2) + Sqrt((s(12) - x(0))**2 + (s(10) + x(2))**2)))/&
            & Sqrt((s(12) - x(0))**2 + (s(10) + x(2))**2) + &
            & (s(1)*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2))*(x(2) - x(14)))/&
            & Sqrt((s(9) - x(0) + x(12))**2 + (x(2) - x(14))**2)) )/m(2)


    else if (BC_flag == 800 .or. BC_flag == 810 .or. BC_flag == 820) then
        f(1) = x(1)

        f(2) = ( p(1) -b(1)*x(1) - ((-2*s(2)*(-Sqrt(s(10)**2 + s(12)**2) + Sqrt(s(10)**2 + (s(12) - x(0))**2))*(s(12) - x(0)))/&
        &   Sqrt(s(10)**2 + (s(12) - x(0))**2) + (s(1)*(s(9) - x(-12) + x(0))*(-s(9) + Sqrt((s(9) - x(-12) + x(0))**2)))/&
        &   Sqrt((s(9) - x(-12) + x(0))**2) - (s(1)*(s(9) - x(0) + x(12))*(-s(9) + Sqrt((s(9) - x(0) + x(12))**2)))/&
        &   Sqrt((s(9) - x(0) + x(12))**2)) )/m(1)

    end if

    end subroutine calc_f_metabeam


    subroutine calc_f_pendula(BC_flag, lowerBound, upperBound, m, b, p, s, x, f)

    !! Data dictionary
    integer, intent(in) :: BC_flag
    integer, intent(in) :: lowerBound
    integer, intent(in) :: upperBound
    real, intent(in), dimension(DoF) :: m
    real, intent(in), dimension(DoF) :: b
    real, intent(in), dimension(DoF) :: p
    real, intent(in), dimension(s_dim) :: s
    real, intent(in), dimension(lowerBound:upperBound) :: x
    real, intent(out), dimension(noState) :: f

    if (BC_flag == 100) then
        f(1) = x(1)
        f(2) = ( p(1) - b(1)*x(1) - (s(3)*s(4)*s(2)*Sin(x(0)) - s(1)*x(-2) + 2*s(1)*x(0) - s(1)*x(2)) )/m(1)
    else if (BC_flag == 110) then
        f(1) = x(1)
        f(2) = ( p(1) - b(1)*x(1) - (s(3)*s(4)*s(2)*Sin(x(0)) + s(1)*(x(0) - x(2))) )/m(1)
    else if (BC_flag == 120) then
        f(1) = x(1)
        f(2) = ( p(1) - b(1)*x(1) - (s(3)*s(4)*s(2)*Sin(x(0)) - s(1)*x(-2) + s(1)*x(0)) )/m(1)
    else if (BC_flag == 121) then
        f(1) = 0.
        f(2) = 0.
    end if

    end subroutine calc_f_pendula


    subroutine calc_f_phi4(BC_flag, lowerBound, upperBound, m, b, p, s, x, f)

    !! Data dictionary
    integer, intent(in) :: BC_flag
    integer, intent(in) :: lowerBound
    integer, intent(in) :: upperBound
    real, intent(in), dimension(DoF) :: m
    real, intent(in), dimension(DoF) :: b
    real, intent(in), dimension(DoF) :: p
    real, intent(in), dimension(s_dim) :: s
    real, intent(in), dimension(lowerBound:upperBound) :: x
    real, intent(out), dimension(noState) :: f

    if (BC_flag == 100) then
        f(1) = x(1)
        f(2) = ( p(1) - b(1)*x(1) - (s(2) - s(1)*x(-2) + 2*(s(1) + s(3))*x(0) + 3*s(4)*x(0)**2 + 4*s(5)*x(0)**3 - s(1)*x(2)) )/m(1)
    else if (BC_flag == 110) then
        f(1) = x(1)
        f(2) = ( p(1) - b(1)*x(1) - (s(2) + s(1)*x(0) + 2*s(3)*x(0) + 3*s(4)*x(0)**2 + 4*s(5)*x(0)**3 - s(1)*x(2)) )/m(1)
    else if (BC_flag == 120) then
        f(1) = x(1)
        f(2) = ( p(1) - b(1)*x(1) - (s(2) - s(1)*x(-2) + (s(1) + 2*s(3))*x(0) + 3*s(4)*x(0)**2 + 4*s(5)*x(0)**3) )/m(1)
    else if (BC_flag == 121) then
        f(1) = 0.
        f(2) = 0.
    end if

    end subroutine calc_f_phi4


    subroutine calc_load(LC_loc, LC_val_loc, c, t, dt, p_loc, x_loc, L)

    !! Data dictionary
    real, parameter :: PI=3.141592653589793
    integer, intent(in), dimension(3) :: LC_loc
    real, intent(in), dimension(7) :: LC_val_loc
    real, intent(in) :: c, t, dt
    real, intent(in), dimension(4) :: L
    real, intent(out) :: p_loc
    real, intent(out), dimension(2) :: x_loc
    integer :: it

    if ( LC_loc(3) == 1 ) then
        if ( t >= LC_val_loc(1) .and. t <= LC_val_loc(2) ) then
            p_loc = LC_val_loc(3)*SIN(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))
        end if
    else if ( LC_loc(3) == 2 ) then
        if ( t >= LC_val_loc(1) .and. t <= LC_val_loc(2) ) then
            p_loc = LC_val_loc(3)*SIN(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))*&
                & SIN(PI*((t+c*dt)-LC_val_loc(6))/(LC_val_loc(7)-LC_val_loc(6)))**2
        end if
    else if ( LC_loc(3) == 3 ) then ! LC 2 with a ramp
        if ( t >= LC_val_loc(1) .and. t <= LC_val_loc(6)-(LC_val_loc(6)+LC_val_loc(7))/2 ) then
            p_loc = LC_val_loc(3)*SIN(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))*&
                & SIN(PI*((t+c*dt)-LC_val_loc(6))/(LC_val_loc(7)-LC_val_loc(6)))**2
        else if ( t >= LC_val_loc(6)-(LC_val_loc(6)+LC_val_loc(7))/2 .and. t <= LC_val_loc(2) ) then
            p_loc = LC_val_loc(3)*SIN(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))
        end if
    else if ( LC_loc(3) == 9 ) then ! random
        if ( t >= LC_val_loc(1) .and. t <= LC_val_loc(2) ) then
            p_loc = 0.
            do it = 1, NINT( (3*2*LC_val_loc(4)/PI)**(1/1.42) )
                p_loc = p_loc + SIN(2*PI*PI/3*it**1.42*(t+c*dt))
            end do
            p_loc = LC_val_loc(3)*P_loc
        end if
    else if ( LC_loc(3) == 11 ) then
        if ( t >= LC_val_loc(1) .and. t <= LC_val_loc(2) ) then
            x_loc(1) = LC_val_loc(3)*SIN(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))
            x_loc(2) = 2*PI*LC_val_loc(4)*LC_val_loc(3)*COS(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))
        end if
    else if (LC_loc(3) == 12) then
        if ( t >= LC_val_loc(1) .and. t <= LC_val_loc(2) ) then
            x_loc(1) = LC_val_loc(3)*SIN(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))*&
                & SIN(PI*((t+c*dt)-LC_val_loc(1))/(LC_val_loc(2)-LC_val_loc(1)))**2
            x_loc(2) = 2*LC_val_loc(3)*PI*SIN(PI*((t+c*dt)-LC_val_loc(1))/(LC_val_loc(2)-LC_val_loc(1)))*&
                & ( LC_val_loc(4)*COS(2*PI*LC_val_loc(4)*(t+c*dt)+LC_val_loc(5))*&
                & SIN(PI*((t+c*dt)-LC_val_loc(1))/(LC_val_loc(2)-LC_val_loc(1)))+&
                & COS(PI*((t+c*dt)-LC_val_loc(1))/(LC_val_loc(2)-LC_val_loc(1)))*&
                & SIN(2*PI*LC_val_loc(4)*(t+c*dt)+LC_val_loc(5))/(LC_val_loc(2)-LC_val_loc(1)) )
        end if
    else if (LC_loc(3) == 13) then
        if ( t >= LC_val_loc(1) .and. t <= LC_val_loc(2) ) then
            x_loc(1) = L(4) - LC_val_loc(3)*COS(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))
            x_loc(2) = 2*PI*LC_val_loc(4)*LC_val_loc(3)*SIN(2*PI*LC_val_loc(4)*(t+c*dt) + LC_val_loc(5))
        end if
    end if

    end subroutine calc_load


end module sub_rk
